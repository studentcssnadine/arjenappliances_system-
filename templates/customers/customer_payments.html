{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Arjen Appliances Trading</title>
    <link rel="icon" type="image/png" href="{% static 'images/arjen_logo.png' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'images/arjen_logo.png' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #1e3a8a;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f9;
            line-height: 1.6;
        }

        /* Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-text {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            font-weight: 500;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
        }

        /* Main Container */
        .main-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: var(--shadow);
            padding: 2rem 0;
        }

        .menu-items {
            list-style: none;
        }

        .menu-item {
            margin: 0.5rem 0;
        }

        .menu-item a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .menu-item.active a,
        .menu-item a:hover {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 2rem;
            overflow-x: auto;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            color: var(--dark);
            font-size: 2rem;
            font-weight: 600;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Customer Info Card */
        .customer-info-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .customer-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .customer-name {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-item i {
            color: var(--primary);
            width: 20px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .summary-card.success {
            border-left-color: var(--success);
        }

        .summary-card.warning {
            border-left-color: var(--warning);
        }

        .summary-card.danger {
            border-left-color: var(--danger);
        }

        .summary-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .summary-card.success h3 {
            color: var(--success);
        }

        .summary-card.warning h3 {
            color: var(--warning);
        }

        .summary-card.danger h3 {
            color: var(--danger);
        }

        .summary-card p {
            color: #666;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success), #27ae60);
            transition: width 0.3s ease;
        }

        /* Payment Breakdown Table */
        .payment-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-bottom: 1px solid #e9ecef;
        }

        .table-title {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 1rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* Transaction Number Column Styling */
        th:nth-child(1), td:nth-child(1) {
            text-align: center;
            width: 120px;
            font-size: 0.9rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }

        .status-overdue {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }

        /* Currency Formatting */
        .currency {
            font-weight: 600;
            color: var(--success);
        }

        /* Action Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .navbar { padding: 0.75rem 1rem; }
            .content { padding: 1rem; }
            .sidebar {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }
            
            .content {
                padding: 1rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .customer-details {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.5rem 0.25rem;
            }
            
            /* Enable horizontal scroll for wide tables */
            .payment-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .payment-table-container table { min-width: 900px; }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="brand">
            <i class="fas fa-home"></i>
            <div class="brand-text">ARJEN APPLIANCES TRADING</div>
        </div>
        <div class="user-menu">
            {% include 'includes/user_profile_dropdown.html' %}
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Sidebar Menu -->
        <aside class="sidebar">
            <ul class="menu-items">
                <li class="menu-item">
                    <a href="{% if user.role == 'admin' %}{% url 'admin_dashboard' %}{% else %}{% url 'staff_dashboard' %}{% endif %}">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="menu-item active">
                    <a href="{% url 'customers_list' %}">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="{% url 'payments' %}">
                        <i class="fas fa-credit-card"></i>
                        <span>Payments</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="{% url 'due_payments_report' %}">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Due Payments</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="{% url 'reports' %}">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                {% if user.role == 'admin' %}
                <li class="menu-item">
                    <a href="{% url 'manage_users' %}">
                        <i class="fas fa-user-cog"></i>
                        <span>Manage Users</span>
                    </a>
                </li>
                {% endif %}
                
                </li>
            </ul>
        </aside>

        <!-- Content Area -->
        <main class="content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Payment History</h1>
                    <div class="breadcrumb">
                        <a href="{% url 'customers_list' %}">Customers</a>
                        <i class="fas fa-chevron-right"></i>
                        <span>{{ customer.customers_name }}</span>
                        <i class="fas fa-chevron-right"></i>
                        <span>Payments</span>
                    </div>
                </div>
                <a href="{% url 'customers_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Customers
                </a>
            </div>

            <!-- Customer Information -->
            <div class="customer-info-card">
                <div class="customer-info-header">
                    <h2 class="customer-name">{{ customer.customers_name }}</h2>
                </div>
                <div class="customer-details">
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ customer.address }}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>{{ customer.contact }}</span>
                    </div>
                    {% if customer.active_items %}
                        {% for item in customer.active_items %}
                        <div class="item-card clickable-item" 
                             data-item-id="{{ item.id }}"
                             data-item-name="{{ item.item_name }} {{ item.item_model }}"
                             data-total-paid="{{ item.total_paid|default:0 }}"
                             data-remaining-balance="{{ item.remaining_balance|default:item.total_contract_amount }}"
                             data-payments-made="{{ item.payments_made_count|default:0 }}"
                             data-payments-remaining="{{ item.payments_remaining_count|default:item.term_months }}"
                             data-payment-progress="{{ item.payment_progress_percentage|default:0 }}"
                             data-delivery-date="{{ item.purchase_date|date:'M d, Y' }}"
                             onclick="selectItem(this)"
                             style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <i class="fas fa-box" style="color: #1e3a8a; font-size: 1.2rem;"></i>
                                <div style="font-weight: 600; color: #1e3a8a; font-size: 1.1rem;">{{ item.item_name }} {{ item.item_model }}</div>
                                <i class="fas fa-chevron-right" style="margin-left: auto; color: #6c757d; font-size: 0.9rem;"></i>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-left: 32px;">
                                <div style="display: flex; flex-direction: column;">
                                    <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500;">Monthly Due</span>
                                    <span style="font-weight: 600; color: #28a745; font-size: 1rem;">‚Ç±{{ item.monthly_due|floatformat:2 }}</span>
                                </div>
                                <div style="display: flex; flex-direction: column;">
                                    <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500;">Rebate</span>
                                    <span style="font-weight: 600; color: #dc3545; font-size: 1rem;">‚Ç±{{ item.rebate_amount|floatformat:2|default:"0.00" }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="detail-item">
                            <i class="fas fa-box"></i>
                            <span style="color: #666;">No items listed</span>
                        </div>
                    {% endif %}
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span id="delivery_date_display">Delivered: {{ customer.date_delivered|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="summary-grid">
                <div class="summary-card success">
                    <h3>‚Ç±{{ total_paid|floatformat:2 }}</h3>
                    <p>Total Paid</p>
                </div>
                <div class="summary-card {% if balance > 0 %}danger{% else %}success{% endif %}">
                    <h3>‚Ç±{{ balance|floatformat:2 }}</h3>
                    <p>Remaining Balance</p>
                </div>
                <div class="summary-card">
                    <h3>{{ payments_made }} / {{ actual_term }}</h3>
                    <p>Payments Made</p>
                </div>
                <div class="summary-card {% if payments_remaining > 0 %}warning{% else %}success{% endif %}">
                    <h3>{{ payments_remaining }}</h3>
                    <p>Payments Remaining</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-header">
                    <h3><i class="fas fa-chart-line"></i> Payment Progress</h3>
                    <span>{{ progress_percentage }}% Complete</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="payment-progress-fill"></div>
                </div>
            </div>

            <!-- Payment Breakdown -->
            <div class="payment-table-container">
                <div class="table-header">
                    <h2 class="table-title">
                        <i class="fas fa-list"></i> Payment Breakdown
                    </h2>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Transaction #</th>
                            <th>Due Date</th>
                            <th>Date Paid / Time</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Rebate</th>
                            <th>Status</th>
                            <th>Balance</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if payment_breakdown %}
                            <!-- DEBUG: Payment breakdown count: {{ payment_breakdown|length }} -->
                            {% for payment in payment_breakdown %}
                            <tr class="payment-row" data-item-id="{{ payment.customer_item.id|default:'' }}">
                            <!-- DEBUG: Payment {{ forloop.counter }}: due={{ payment.due_date }}, paid={{ payment.date_paid }}, amount={{ payment.amount_paid_display }} -->
                            <td>
                                {% if payment.transaction_number %}
                                    {{ payment.transaction_number }}
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td>{{ payment.due_date|date:"M d, Y" }}</td>
                            <td>
                                {% if payment.date_paid %}
                                    <span title="{{ payment.created_at|date:'M d, Y, h:i:s A' }}">
                                        {{ payment.date_paid|date:"M d, Y" }}<br>
                                        <span style="color: #6c757d; font-size: 0.85rem;">{{ payment.created_at|date:"h:i:s A" }}</span>
                                    </span>
                                {% else %}
                                    <span style="color: #999;">Not paid</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if payment.amount_paid_display %}
                                    <span class="currency">{{ payment.amount_paid_display }}</span>
                                {% else %}
                                    <span class="currency">‚Ç±{{ customer.monthly_due|floatformat:2 }}</span>
                                {% endif %}
                            </td>
                            <td>{{ payment.payment_method|default:"-" }}</td>
                            <td>
                                {% if payment.rebate_amount %}
                                    <span class="currency">‚Ç±{{ payment.rebate_amount|floatformat:2 }}</span>
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-badge status-{{ payment.status }}">
                                    {{ payment.status|capfirst }}
                                </span>
                            </td>
                            <td class="currency">‚Ç±{{ payment.running_balance|floatformat:2 }}</td>
                            <td>{{ payment.notes|default:"-" }}</td>
                        </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <script>
        let selectedItemId = null;
        let allPayments = []; // This would be populated with all payment data
        
        // Initialize payments data from Django backend
        try {
            window.paymentsData = JSON.parse('{{ payments_json|default:"[]"|escapejs }}');
        } catch (e) {
            console.error('Error parsing payments data:', e);
            window.paymentsData = [];
        }
        
        // Set progress bar width
        document.addEventListener('DOMContentLoaded', function() {
            const progressFill = document.getElementById('payment-progress-fill');
            if (progressFill) {
                progressFill.style.width = '{{ progress_percentage }}%';
            }
        });
        
        // Debug: Log available data on page load
        console.log('=== PAYMENT BREAKDOWN DEBUG ===');
        console.log('Payment breakdown available:', 0);
        console.log('Recent payments available:', 0);
        console.log('Customer active items:', 0);
        // Store original summary data for "All Items" view
        const originalSummary = {
            totalPaid: 0,
            remainingBalance: 0,
            paymentsMade: 0,
            paymentsRemaining: 0,
            paymentProgress: 0
        };

        // ‚öôÔ∏è SIMPLE SUMMARY BOX UPDATER (Clean Implementation)
        function updateSummaryBoxesSimple(balance, paymentsMade, totalTerm, totalPaidWithRebates) {
            try {
                const cards = document.querySelectorAll('.summary-card');
                
                // Update Total Paid (index 0) - FIXED: Include rebates
                if (cards[0] && totalPaidWithRebates !== undefined) {
                    const h3 = cards[0].querySelector('h3');
                    if (h3) {
                        h3.textContent = '‚Ç±' + totalPaidWithRebates.toLocaleString('en-US', {minimumFractionDigits: 2});
                    }
                }
                
                // Update Remaining Balance (index 1)
                if (cards[1]) {
                    const h3 = cards[1].querySelector('h3');
                    if (h3) {
                        h3.textContent = '‚Ç±' + balance.toLocaleString('en-US', {minimumFractionDigits: 2});
                    }
                }
                
                // Update Payments Made (index 2)
                if (cards[2]) {
                    const h3 = cards[2].querySelector('h3');
                    if (h3) {
                        h3.textContent = paymentsMade + ' / ' + totalTerm;
                    }
                }
                
                // Update Payments Remaining (index 3)
                if (cards[3]) {
                    const h3 = cards[3].querySelector('h3');
                    if (h3) {
                        const remaining = totalTerm - paymentsMade;
                        h3.textContent = remaining.toString();
                    }
                }
                
                console.log('‚úÖ Summary boxes updated:', {
                    balance: balance,
                    paymentsMade: paymentsMade,
                    totalTerm: totalTerm,
                    remaining: totalTerm - paymentsMade
                });
            } catch (error) {
                console.error('‚ùå Error updating summary boxes:', error);
            }
        }

        function selectItem(itemElement) {
            console.log('selectItem called with element:', itemElement);
            
            // Remove active class from all items
            document.querySelectorAll('.clickable-item').forEach(item => {
                item.style.borderColor = '#e9ecef';
                item.style.backgroundColor = '#f8f9fa';
                item.style.boxShadow = 'none';
            });
            
            // Add active styling to selected item
            itemElement.style.borderColor = '#1e3a8a';
            itemElement.style.backgroundColor = '#f0f4ff';
            itemElement.style.boxShadow = '0 4px 12px rgba(30, 58, 138, 0.15)';
            
            // Get item data
            const itemId = itemElement.dataset.itemId;
            const itemName = itemElement.dataset.itemName;
            const totalPaid = parseFloat(itemElement.dataset.totalPaid) || 0;
            const remainingBalance = parseFloat(itemElement.dataset.remainingBalance) || 0;
            const paymentsMade = parseInt(itemElement.dataset.paymentsMade) || 0;
            const paymentsRemaining = parseInt(itemElement.dataset.paymentsRemaining) || 0;
            const paymentProgress = parseFloat(itemElement.dataset.paymentProgress) || 0;
            
            console.log('Item data extracted:', {
                itemId, itemName, totalPaid, remainingBalance, 
                paymentsMade, paymentsRemaining, paymentProgress
            });
            
            selectedItemId = itemId;
            
            // Update summary cards
            updateSummaryCards(totalPaid, remainingBalance, paymentsMade, paymentsRemaining, paymentProgress);
            
            // Update page title or add indicator
            updatePageIndicator(itemName);
            
            // Filter payment breakdown table (if exists)
            filterPaymentBreakdown(itemId);
            
            console.log('Selected item:', itemName, 'ID:', itemId);
        }
        
        function updateSummaryCards(totalPaid, remainingBalance, paymentsMade, paymentsRemaining, paymentProgress) {
            // Get all summary cards
            const summaryCards = document.querySelectorAll('.summary-card');
            
            // Update Total Paid (first card - success)
            const totalPaidCard = summaryCards[0];
            if (totalPaidCard) {
                const h3Element = totalPaidCard.querySelector('h3');
                if (h3Element) {
                    h3Element.textContent = '‚Ç±' + totalPaid.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
            }
            
            // Update Remaining Balance (second card)
            const remainingBalanceCard = summaryCards[1];
            if (remainingBalanceCard) {
                const h3Element = remainingBalanceCard.querySelector('h3');
                if (h3Element) {
                    h3Element.textContent = '‚Ç±' + remainingBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                // Update card color based on balance
                if (remainingBalance > 0) {
                    remainingBalanceCard.className = 'summary-card danger';
                } else {
                    remainingBalanceCard.className = 'summary-card success';
                }
            }
            
            // Update Payments Made (third card)
            const paymentsMadeCard = summaryCards[2];
            if (paymentsMadeCard) {
                const h3Element = paymentsMadeCard.querySelector('h3');
                if (h3Element) {
                    const totalPayments = paymentsMade + paymentsRemaining;
                    h3Element.textContent = paymentsMade + ' / ' + totalPayments;
                }
            }
            
            // Update Payments Remaining (fourth card)
            const paymentsRemainingCard = summaryCards[3];
            if (paymentsRemainingCard) {
                const h3Element = paymentsRemainingCard.querySelector('h3');
                if (h3Element) {
                    h3Element.textContent = paymentsRemaining.toString();
                }
                // Update card color based on remaining payments
                if (paymentsRemaining > 0) {
                    paymentsRemainingCard.className = 'summary-card warning';
                } else {
                    paymentsRemainingCard.className = 'summary-card success';
                }
            }
            
            // Update progress bar
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-header span');
            
            if (progressFill) {
                progressFill.style.width = paymentProgress + '%';
            }
            
            if (progressText) {
                progressText.textContent = paymentProgress.toFixed(1) + '% Complete';
            }
            
            console.log('Updated summary cards:', {
                totalPaid, remainingBalance, paymentsMade, paymentsRemaining, paymentProgress
            });
        }
        
        function updatePageIndicator(itemName) {
            // Add or update item indicator
            let indicator = document.querySelector('.item-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'item-indicator';
                indicator.style.cssText = `
                    background: #1e3a8a;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 0.9rem;
                    font-weight: 600;
                    margin: 10px 0;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                `;
                
                // Insert after customer name
                const customerHeader = document.querySelector('.customer-header');
                if (customerHeader) {
                    customerHeader.appendChild(indicator);
                }
            }
            
            // UNIVERSAL PAYMENT DATA RETRIEVAL FOR ALL CUSTOMERS
            // Get payment data from Django backend for this specific customer and item
            console.log('üîç UNIVERSAL: Retrieving payment data for customer and item...');
            
            indicator.innerHTML = `
                <i class="fas fa-filter"></i>
                Viewing: ${itemName}
                <button onclick="showAllItems()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 12px; margin-left: 8px; cursor: pointer; font-size: 0.8rem;">
                    <i class="fas fa-times"></i> Show All
                </button>
            `;
        }
        
        function showAllItems() {
            // Remove active styling from all items
            document.querySelectorAll('.clickable-item').forEach(item => {
                item.style.borderColor = '#e9ecef';
                item.style.backgroundColor = '#f8f9fa';
                item.style.boxShadow = 'none';
            });
            
            // Reset to zero values (no item selected)
            updateSummaryCards(0, 0, 0, 0, 0);
            
            // Remove item indicator
            const indicator = document.querySelector('.item-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            selectedItemId = null;
            
            // Show all payments in breakdown
            filterPaymentBreakdown(null);
            
            // Reset delivery date
            updateDeliveryDate(null);
            
            // ‚öôÔ∏è REAL-TIME SYNC: Use backend summary (full months covered)
            const totalPaymentsMade = parseInt('{{ payments_made }}') || 0;
            const totalTerm = parseInt('{{ actual_term }}') || 0;
            const totalBalance = parseFloat('{{ balance }}') || 0;
            
            console.log('‚öôÔ∏è TOTAL CUSTOMER SYNC:', {
                'Total Payments Made': totalPaymentsMade,
                'Total Term': totalTerm,
                'Total Balance': totalBalance
            });
            
            updateSummaryBoxes(totalBalance, totalPaymentsMade, totalTerm);
        }
        
        // ‚öôÔ∏è UNIVERSAL SUMMARY BOX UPDATER
        function updateSummaryBoxes(currentBalance, paymentsMade, totalTerm) {
            const summaryCards = document.querySelectorAll('.summary-card');
            
            // Update Remaining Balance (second card)
            if (summaryCards[1]) {
                const h3Element = summaryCards[1].querySelector('h3');
                if (h3Element) {
                    h3Element.textContent = '‚Ç±' + currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
                    console.log('‚öôÔ∏è Updated Remaining Balance box to:', h3Element.textContent);
                }
                
                // Update card color based on balance
                summaryCards[1].className = currentBalance > 0 ? 'summary-card danger' : 'summary-card success';
            }
            
            // Update Payments Made (third card)
            if (summaryCards[2]) {
                const h3Element = summaryCards[2].querySelector('h3');
                if (h3Element) {
                    h3Element.textContent = `${paymentsMade} / ${totalTerm}`;
                    console.log('‚öôÔ∏è Updated Payments Made box to:', h3Element.textContent);
                }
            }
            
            // Update Payments Remaining (fourth card)
            if (summaryCards[3]) {
                const h3Element = summaryCards[3].querySelector('h3');
                if (h3Element) {
                    const paymentsRemaining = totalTerm - paymentsMade;
                    h3Element.textContent = paymentsRemaining.toString();
                    console.log('‚öôÔ∏è Updated Payments Remaining box to:', h3Element.textContent);
                }
            }
        }
        
        function filterPaymentBreakdown(itemId) {
            console.log('Filtering payment breakdown for item ID:', itemId);
            
            // Since Recent Payment Records was removed, only handle Payment Breakdown table
            const allTables = document.querySelectorAll('table');
            let paymentBreakdownRows = [];
            
            // Find Payment Breakdown table
            allTables.forEach(table => {
                const previousHeading = table.closest('.payment-table-container')?.querySelector('h2');
                if (previousHeading && previousHeading.textContent.includes('Payment Breakdown')) {
                    const rows = table.querySelectorAll('tbody .payment-row');
                    paymentBreakdownRows = Array.from(rows);
                }
            });
            
            console.log(`Found ${paymentBreakdownRows.length} rows in Payment Breakdown table`);
            
            if (!itemId) {
                // When no item is selected, HIDE all payment breakdown rows (empty state)
                paymentBreakdownRows.forEach(row => {
                    row.style.display = 'none';  // Hide all payment breakdown rows
                });
                return;
            }
            
            // Show Payment Breakdown rows that match the selected item ID OR show all for legacy payments
            let matchingBreakdownRows = 0;
            paymentBreakdownRows.forEach(row => {
                const rowItemId = row.dataset.itemId;
                console.log(`Checking Payment Breakdown row: itemId="${rowItemId}" vs selected="${itemId}"`);
                
                // Show payment breakdown row if:
                // 1. It matches the selected item ID, OR
                // 2. It has no item ID (legacy payment) - show all breakdown rows
                const shouldShow = (rowItemId === itemId) || (!rowItemId || rowItemId === '');
                
                if (shouldShow) {
                    row.style.display = '';
                    matchingBreakdownRows++;
                    console.log(`‚úÖ Showing Payment Breakdown row with itemId=${rowItemId}`);
                } else {
                    row.style.display = 'none';
                }
            });
            console.log(`Total matching Payment Breakdown rows found: ${matchingBreakdownRows}`);
            
            // Get the selected item data
            const selectedItemCard = document.querySelector(`[data-item-id="${itemId}"]`);
            if (!selectedItemCard) {
                console.log('Selected item card not found');
                return;
            }
            
            // Get item financial data from data attributes (real data)
            const itemName = selectedItemCard.dataset.itemName;
            const totalPaid = parseFloat(selectedItemCard.dataset.totalPaid) || 0;
            const remainingBalance = parseFloat(selectedItemCard.dataset.remainingBalance) || 0;
            const paymentsMade = parseInt(selectedItemCard.dataset.paymentsMade) || 0;
            const paymentsRemaining = parseInt(selectedItemCard.dataset.paymentsRemaining) || 6;
            
            // Get the actual monthly due from the item card data attribute or display
            let monthlyDue = 0;
            
            // First try to get from data attribute
            if (selectedItemCard.dataset.monthlyDue) {
                monthlyDue = parseFloat(selectedItemCard.dataset.monthlyDue);
            } else {
                // Fallback: Find the monthly due in the item card text
                // Look for the pattern "Monthly Due: ‚Ç±X,XXX.XX"
                const cardText = selectedItemCard.textContent;
                const monthlyDueMatch = cardText.match(/Monthly Due[:\s]*‚Ç±([\d,]+\.?\d*)/i);
                if (monthlyDueMatch) {
                    monthlyDue = parseFloat(monthlyDueMatch[1].replace(/,/g, ''));
                } else {
                    // Last resort: use a default based on remaining balance and payments
                    monthlyDue = remainingBalance / paymentsRemaining;
                }
            }
            
            console.log('Real item financial data:', {
                itemName, totalPaid, remainingBalance, paymentsMade, paymentsRemaining, monthlyDue
            });
            
            // Debug: Calculate expected total contract
            const expectedTotalContract = paymentsRemaining * monthlyDue;
            console.log('Expected calculations:', {
                'Term (paymentsRemaining)': paymentsRemaining,
                'Monthly Due': monthlyDue,
                'Expected Total Contract': expectedTotalContract,
                'Current Remaining Balance': remainingBalance,
                'Difference': expectedTotalContract - remainingBalance
            });
            
            // Hide existing payment rows
            document.querySelectorAll('.payment-row').forEach(row => {
                row.style.display = 'none';
            });
            
            // Generate payment schedule for this item using item-specific delivery date
            // FIX: Pass total term (paymentsMade + paymentsRemaining) instead of just paymentsRemaining
            const totalTerm = paymentsMade + paymentsRemaining;
            generateItemPaymentBreakdown(itemId, itemName, monthlyDue, totalTerm, totalPaid, remainingBalance);
            
            // Update delivery date based on selected item
            updateDeliveryDate(itemId);
        }
        
        function generateItemPaymentBreakdown(itemId, itemName, monthlyDue, termMonths, totalPaid, remainingBalance) {
            console.log('generateItemPaymentBreakdown called with:', {itemId, itemName, monthlyDue, termMonths, totalPaid, remainingBalance});
            
            // Find the payment breakdown table body
            let tableBody = document.querySelector('.payment-table-container tbody');
            console.log('Table body found:', tableBody);
            
            if (!tableBody) {
                console.log('Payment table body not found - trying alternative selector');
                tableBody = document.querySelector('tbody');
                console.log('Alternative table body:', tableBody);
                if (!tableBody) {
                    console.log('No table body found at all');
                    return;
                }
            }
            
            // Clear existing generated rows
            document.querySelectorAll('.generated-payment-row').forEach(row => row.remove());
            
            // Get actual payment data from backend - use the global payments data
            const actualPayments = [];
            
            // Use the payments data that was passed from Django backend
            if (window.paymentsData && window.paymentsData.length > 0) {
                // Filter payments for this specific item (or legacy payments without item link)
                window.paymentsData.forEach(payment => {
                    if (!payment.customer_item_id || payment.customer_item_id == itemId) {
                        actualPayments.push({
                            date: payment.payment_date,
                            time: payment.created_time || '',
                            fullTimestamp: payment.created_at || '',
                            transactionNumber: payment.transaction_number || '',
                            amount: '‚Ç±' + parseFloat(payment.amount_paid).toLocaleString('en-US', {minimumFractionDigits: 2}),
                            method: payment.payment_method,
                            recordedBy: payment.recorded_by || 'System',
                            notes: payment.notes || '',
                            rawAmount: parseFloat(payment.amount_paid),
                            rebateAmount: parseFloat(payment.rebate_amount || 0),
                            paymentId: payment.id
                        });
                    }
                });
            }
            
            console.log('‚úÖ REAL PAYMENT DATA: Retrieved payment history:', actualPayments);
            
            console.log(`Found ${actualPayments.length} actual payments for item ${itemId}:`, actualPayments);
            
            // Generate payment schedule for this item using item-specific delivery date
            const selectedItemCard = document.querySelector(`[data-item-id="${itemId}"]`);
            let startDate;
            
            if (selectedItemCard && selectedItemCard.dataset.deliveryDate) {
                // Parse the item's actual delivery date
                const deliveryDateStr = selectedItemCard.dataset.deliveryDate;
                startDate = new Date(deliveryDateStr);
                console.log(`Using item delivery date: ${deliveryDateStr} for item: ${itemName}`);
            } else {
                // Fallback to current date if no delivery date found
                startDate = new Date();
                console.log(`No delivery date found for item: ${itemName}, using current date`);
            }
            
            // ‚öôÔ∏è UNIVERSAL BALANCE COMPUTATION SYSTEM FOR ALL CUSTOMERS
            // Rule 1: Compute Initial Balance using REAL backend data
            // Initial Balance = Total Paid (payments + rebates) + Remaining Balance
            const initialBalance = totalPaid + remainingBalance;
            
            console.log('‚öôÔ∏è UNIVERSAL BALANCE COMPUTATION FOR ALL CUSTOMERS:', {
                'Customer': itemName,
                'Term': termMonths,
                'Monthly Due': monthlyDue,
                'Initial Balance (Term √ó Monthly Due)': initialBalance,
                'Payment History Count': actualPayments.length
            });
            
            // Rule 2: Calculate running balances for each payment
            let runningBalances = [initialBalance]; // Start with initial balance
            let cumulativeDeductions = 0;
            
            actualPayments.forEach((payment, index) => {
                // Conditional Rebate Logic
                let totalDeduction;
                if (payment.rebateAmount > 0) {
                    // Customer HAS rebate: Total Deduction = Payment + Rebate
                    totalDeduction = payment.rawAmount + payment.rebateAmount;
                    console.log(`‚öôÔ∏è Payment ${index + 1} (WITH REBATE): ‚Ç±${payment.rawAmount} + ‚Ç±${payment.rebateAmount} rebate = ‚Ç±${totalDeduction} total deduction`);
                } else {
                    // Customer has NO rebate: Total Deduction = Payment only
                    totalDeduction = payment.rawAmount;
                    console.log(`‚öôÔ∏è Payment ${index + 1} (NO REBATE): ‚Ç±${payment.rawAmount} only = ‚Ç±${totalDeduction} total deduction`);
                }
                cumulativeDeductions += totalDeduction;
                
                // Calculate balance after this payment
                const balanceAfterPayment = initialBalance - cumulativeDeductions;
                runningBalances.push(balanceAfterPayment);
            });
            
            // Rule 3: Current balance should match backend remainingBalance
            const currentBalance = remainingBalance;
            console.log('‚öôÔ∏è BALANCE COMPUTATION RESULT:', {
                'Initial Balance': initialBalance,
                'Total Deductions': cumulativeDeductions,
                'Current Balance': currentBalance,
                'Running Balances': runningBalances
            });

            // ‚öôÔ∏è SUMMARY COUNTS BASED ON FULL MONTHLY DUES
            let fullMonthsPaid = 0;
            if (monthlyDue > 0) {
                fullMonthsPaid = Math.floor(cumulativeDeductions / monthlyDue);
                if (fullMonthsPaid > termMonths) {
                    fullMonthsPaid = termMonths;
                }
            }
            const paymentsMadeForSummary = fullMonthsPaid;
            const paymentsRemainingForSummary = termMonths - paymentsMadeForSummary;

            console.log('‚öôÔ∏è REAL-TIME SYNC DATA (FULL MONTHS):', {
                'Full Months Paid': paymentsMadeForSummary,
                'Total Term': termMonths,
                'Payments Remaining': paymentsRemainingForSummary,
                'Current Balance': currentBalance
            });

            // ‚öôÔ∏è UPDATE SUMMARY BOXES WITH CLEAN FUNCTION
            console.log('üîß CALLING updateSummaryBoxesSimple with:', {
                balance: currentBalance,
                paymentsMade: paymentsMadeForSummary,
                termMonths: termMonths,
                totalPaidWithRebates: cumulativeDeductions
            });

            updateSummaryBoxesSimple(currentBalance, paymentsMadeForSummary, termMonths, cumulativeDeductions);
            
            // ‚öôÔ∏è FORCE UPDATE - Direct DOM manipulation as backup
            setTimeout(() => {
                const cards = document.querySelectorAll('.summary-card');
                console.log('üîß Found summary cards:', cards.length);
                
                // Update Total Paid (index 0) - FIXED: Include rebates
                if (cards[0]) {
                    const h3 = cards[0].querySelector('h3');
                    if (h3) {
                        h3.textContent = '‚Ç±' + cumulativeDeductions.toLocaleString('en-US', {minimumFractionDigits: 2});
                        console.log('üîß FORCE UPDATED Total Paid to:', h3.textContent);
                    }
                }
                
                // Update Remaining Balance (index 1)
                if (cards[1]) {
                    const h3 = cards[1].querySelector('h3');
                    if (h3) {
                        h3.textContent = '‚Ç±' + currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2});
                        console.log('üîß FORCE UPDATED Remaining Balance to:', h3.textContent);
                    }
                }
                
                // Update Payments Made (index 2)
                if (cards[2]) {
                    const h3 = cards[2].querySelector('h3');
                    if (h3) {
                        h3.textContent = `${paymentsMadeForSummary} / ${termMonths}`;
                        console.log('üîß FORCE UPDATED Payments Made to:', h3.textContent);
                    }
                }

                // Update Payments Remaining (index 3)
                if (cards[3]) {
                    const h3 = cards[3].querySelector('h3');
                    if (h3) {
                        const remaining = termMonths - paymentsMadeForSummary;
                        h3.textContent = remaining.toString();
                        console.log('üîß FORCE UPDATED Payments Remaining to:', h3.textContent);
                    }
                }
            }, 100);
            
            for (let i = 0; i < termMonths; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(dueDate.getMonth() + i + 1); // Add 1 month to delivery date for first payment
                
                // Check if there's an actual payment for this slot (proper chronological matching)
                // Match payments to payment slots based on chronological order
                const actualPayment = actualPayments[i] || null;
                
                console.log(`Row ${i + 1}: actualPayment =`, actualPayment ? 'HAS PAYMENT' : 'NO PAYMENT');
                
                // ‚öôÔ∏è UNIVERSAL BALANCE SYNCHRONIZATION FOR ALL CUSTOMERS
                // Rule 4: Show running balance based on payment history
                let balanceBeforePayment;
                
                if (i < runningBalances.length) {
                    // Show the balance at this point in payment history
                    balanceBeforePayment = runningBalances[i];
                } else {
                    // For future payments, show the current balance (after all payments made so far)
                    balanceBeforePayment = currentBalance;
                }
                
                console.log(`‚öôÔ∏è Row ${i + 1} Balance: ‚Ç±${balanceBeforePayment.toLocaleString('en-US', {minimumFractionDigits: 2})}`);
                
                // Determine payment status and display
                let datePaidDisplay, amountDisplay, methodDisplay, statusClass, statusText;
                
                if (actualPayment) {
                    // Payment exists - show actual payment data from PaymentRecord
                    // Show date and time like Payments page
                    if (actualPayment.time) {
                        const safeTimestamp = actualPayment.fullTimestamp || `${actualPayment.date} ${actualPayment.time}`;
                        datePaidDisplay = `<span title="${safeTimestamp}">${actualPayment.date}<br><span style="color: #6c757d; font-size: 0.85rem;">${actualPayment.time}</span></span>`;
                    } else {
                        datePaidDisplay = actualPayment.date;
                    }
                    amountDisplay = actualPayment.amount;
                    methodDisplay = actualPayment.method;
                    statusClass = 'status-paid';
                    statusText = 'Paid';
                    
                    // üßÆ AUTOMATED DEDUCTION: Payment + Rebate already calculated in cumulativeDeductions
                    const effectivePayment = actualPayment.rawAmount + (actualPayment.rebateAmount || 0);
                    console.log('üßÆ AUTOMATED DEDUCTION:', {
                        'Amount Paid': actualPayment.rawAmount,
                        'Rebate': actualPayment.rebateAmount || 0,
                        'Total Deduction': effectivePayment,
                        'Balance Before Payment': balanceBeforePayment,
                        'Balance After Payment': balanceBeforePayment - effectivePayment
                    });
                    // Note: Balance is already calculated automatically above
                } else {
                    // No payment - show pending/overdue with ‚Ç±0.00 amount
                    const currentDate = new Date();
                    const isOverdue = dueDate < currentDate;
                    datePaidDisplay = '<span style="color: #999;">Not paid</span>';
                    amountDisplay = '<strong>‚Ç±0.00</strong>';  // Show ‚Ç±0.00 for unpaid
                    methodDisplay = '-';
                    statusClass = isOverdue ? 'status-overdue' : 'status-pending';
                    statusText = isOverdue ? 'Overdue' : 'Pending';
                    // Balance stays the same for unpaid rows
                }
                
                const row = document.createElement('tr');
                row.className = 'payment-row generated-payment-row';
                row.dataset.itemId = itemId;
                row.style.backgroundColor = i % 2 === 0 ? '#f8f9fa' : '#ffffff';
                
                // ‚öôÔ∏è UNIVERSAL REBATE DISPLAY (Conditional Logic)
                let rebateDisplay = '-';
                if (actualPayment) {
                    if (actualPayment.rebateAmount > 0) {
                        // Customer HAS rebate: Show rebate amount
                        rebateDisplay = '‚Ç±' + actualPayment.rebateAmount.toLocaleString('en-US', {minimumFractionDigits: 2});
                    } else {
                        // Customer has NO rebate: Show dash
                        rebateDisplay = '-';
                    }
                }
                
                // Transaction number display
                let transactionNumberDisplay = '-';
                if (actualPayment && actualPayment.transactionNumber) {
                    transactionNumberDisplay = actualPayment.transactionNumber;
                    console.log(`‚öôÔ∏è Row ${i + 1} Transaction #: ${transactionNumberDisplay}`);
                } else {
                    console.log(`‚öôÔ∏è Row ${i + 1} Transaction #: No transaction number available`);
                }
                
                // Notes display: use actual note text when available, otherwise show dash
                let notesDisplay = '-';
                if (actualPayment && actualPayment.notes && actualPayment.notes.trim() !== '') {
                    notesDisplay = actualPayment.notes;
                }

                row.innerHTML = `
                    <td>${transactionNumberDisplay}</td>
                    <td>${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${datePaidDisplay}</td>
                    <td>${amountDisplay}</td>
                    <td>${methodDisplay}</td>
                    <td>${rebateDisplay}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="currency">‚Ç±${Math.max(0, balanceBeforePayment).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>${notesDisplay}</td>
                `;
                
                tableBody.appendChild(row);
            }

            // Add a final summary row showing the remaining balance AFTER all payments
            // Only if:
            // 1) there is at least one actual payment,
            // 2) the item still has a positive remaining balance, and
            // 3) the LAST payment was NOT a full monthly due (partial last payment).
            let shouldShowRemainingRow = false;
            if (actualPayments.length > 0 && currentBalance > 0 && monthlyDue > 0) {
                const lastPayment = actualPayments[actualPayments.length - 1];
                const lastDeduction = (lastPayment.rawAmount || 0) + (lastPayment.rebateAmount || 0);
                if (lastDeduction < monthlyDue) {
                    shouldShowRemainingRow = true;
                }
            }

            if (shouldShowRemainingRow) {
                const remainingRow = document.createElement('tr');
                remainingRow.className = 'payment-row generated-payment-row';
                remainingRow.dataset.itemId = itemId;
                remainingRow.style.backgroundColor = '#fffbe6';

                const remainingBalanceDisplay = '‚Ç±' + Math.max(0, currentBalance).toLocaleString('en-US', {minimumFractionDigits: 2});

                remainingRow.innerHTML = `
                    <td>-</td>
                    <td>-</td>
                    <td><span style="color: #666; font-weight: 600;">Remaining Balance</span></td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td><span class="status-badge status-pending">PENDING</span></td>
                    <td class="currency">${remainingBalanceDisplay}</td>
                    <td>-</td>
                `;

                tableBody.appendChild(remainingRow);
                console.log('‚úÖ Added remaining balance row with balance =', remainingBalanceDisplay);
            }
            
            console.log(`Generated ${termMonths} payment rows for ${itemName}`);
        }
        
        function updateDeliveryDate(itemId) {
            // Find the delivery date display element
            const deliveryDateElement = document.querySelector('#delivery_date_display');
            if (!deliveryDateElement) {
                console.log('Delivery date element not found');
                return;
            }
            
            if (!itemId) {
                // Reset to original delivery date when no item selected
                deliveryDateElement.textContent = 'Delivered: {{ customer.date_delivered|date:"M d, Y" }}';
                return;
            }
            
            // Get the selected item card to find its delivery/purchase date
            const selectedItemCard = document.querySelector(`[data-item-id="${itemId}"]`);
            if (selectedItemCard) {
                // Get the item-specific delivery date from data attribute
                const itemName = selectedItemCard.dataset.itemName;
                const deliveryDate = selectedItemCard.dataset.deliveryDate;
                
                if (deliveryDate) {
                    deliveryDateElement.textContent = `Delivered: ${deliveryDate} (${itemName})`;
                    console.log(`Updated delivery date for item: ${itemName} - ${deliveryDate}`);
                } else {
                    // Fallback if no delivery date available
                    deliveryDateElement.textContent = `Delivered: Date not available (${itemName})`;
                    console.log('No delivery date found for item:', itemName);
                }
            }
        }
        
        function updatePaymentTableHeaders(itemId, visibleCount, hasItemLinks) {
            // You can add logic here to show/hide table sections or add messages
            // when no payments are found for a specific item
            
            if (itemId && visibleCount === 0) {
                console.log('No payments found for selected item');
                // Could add a "No payments for this item" message here
            }
            
            if (itemId && !hasItemLinks && visibleCount > 0) {
                console.log('Showing all payments as fallback (no item-payment links in database)');
            }
        }
        
        // Initialize page - show actual payment data by default
        function initializePage() {
            // DEBUG: Let's see what payments we have
            const allPaymentRows = document.querySelectorAll('.payment-row');
            console.log(`DEBUG: Found ${allPaymentRows.length} total payment rows`);
            
            allPaymentRows.forEach((row, index) => {
                const itemId = row.dataset.itemId;
                console.log(`DEBUG: Payment row ${index}: itemId="${itemId}"`);
            });
            
            // Hide all payment breakdown rows by default (no item selected)
            const paymentBreakdownRows = document.querySelectorAll('.payment-table-container tbody .payment-row');
            paymentBreakdownRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // Show payments without item ID by default (for customers like Trisha)
            filterPaymentBreakdown(null);
            
            
            // Reset all summary cards to 0 (no item selected)
            updateSummaryCards(0, 0, 0, 0, 0);
            
            console.log('Page initialized - showing actual payment data');
        }

        // Error handling function
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            // Show user-friendly error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> An error occurred while ${context}. Please refresh the page and try again.`;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            // Auto-remove error after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Add hover effects
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize the page
                initializePage();
            } catch (error) {
                handleError(error, 'initializing page');
            }
            
            const itemCards = document.querySelectorAll('.clickable-item');
            
            itemCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    if (this.dataset.itemId !== selectedItemId) {
                        this.style.backgroundColor = '#e8f2ff';
                        this.style.borderColor = '#b3d9ff';
                    }
                });
                
                card.addEventListener('mouseleave', function() {
                    if (this.dataset.itemId !== selectedItemId) {
                        this.style.backgroundColor = '#f8f9fa';
                        this.style.borderColor = '#e9ecef';
                    }
                });
            });
        });
    </script>

    <!-- Staff Profile Modal -->
    {% if user.role == 'staff' %}
    {% include 'modals/staff_profile_modal.html' %}
    {% endif %}
</body>
</html>
